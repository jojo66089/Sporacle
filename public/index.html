<!doctype html>
<html>
<head>
    <title>Sporacle: Spotify Personality Read</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" type="image/jpg" href="favicon.png"/>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><img src="spotify.png" alt="Spotify Logo"> Sporacle</h1>
            <div id="login">
                <a href="/login" class="button">Log in with Spotify</a>
            </div>
        </div>
        <div id="loggedin" class="flex-container" style="display:none;">
            <div id="response-section">
                <h2>Here is your Sporacle:</h2>
                <div id="response"></div>
            </div>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
        (function() {
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    $.ajax({
                        url: '/api/top-tracks',
                        data: { access_token: access_token },
                        success: function(response) {
                            console.log('Top tracks response:', response); // Log the response to the console
                            generateReading(response.items); // Generate the reading based on top tracks
                        },
                        error: function() {
                            console.error('Failed to fetch top tracks');
                        }
                    });
                } else {
                    $('#login').show();
                    $('#loggedin').hide();
                }
            }

            function generateReading(topTracks) {
                const trackNames = topTracks.map(track => track.name);
                fetch('/generate-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trackNames })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').innerText = data.response || data.error;
                    $('#login').hide();
                    $('#loggedin').show();
                })
                .catch(error => {
                    console.error('Error generating reading:', error);
                });
            }
        })();
    </script>
</body>
</html>
